<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal&display=swap" rel="stylesheet">
  <script src="checkauth.js"></script>
  <script src="logout.js"></script>
  <style>
    body {
      font-family: 'Tajawal', sans-serif;
      background-color: #f4f7fc;
      padding: 20px;
    }
    .container {
      max-width: 600px;
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
      margin-top: 50px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #2c3e50;
    }
    input, select, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 16px;
    }
    .form-actions {
      margin-top: 25px;
      display: flex;
      gap: 10px;
    }
    .btn-save {
      background-color: #2973B2;
      color: white;
    }
    .btn-save:hover {
      background-color: #16a085;
    }
    .btn-cancel {
      background-color: #c0392b;
      color: white;
    }
    .btn-cancel:hover {
      background-color: #a93226;
    }
    .toast-container {
      position: fixed;
      top: 1rem;
      left: 1rem;
      z-index: 9999;
    }
  </style>
</head>
<body>
  <div class="toast-container" id="toastContainer"></div>

  <div class="container">
    <h2 id="pageTitle">ØªØ­Ù…ÙŠÙ„â€¦</h2>
    <form id="editForm">
      <div class="form-actions">
        <button type="submit" class="btn btn-save">ğŸ’¾ Ø­ÙØ¸</button>
        <button type="button" class="btn btn-cancel" onclick="history.back()">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </form>
  </div>

  <script>
    checkAuth(["admin"]);
  </script>
  <script>
    const qs = new URLSearchParams(location.search);
    const role = qs.get('role');
    const id = qs.get('id');
    const form = document.getElementById('editForm');
    const title = document.getElementById('pageTitle');
    const apiMap = {
      patient: 'https://localhost:7145/api/Patient',
      hospital: 'https://localhost:7145/api/Hospitals',
      admin: 'https://localhost:7145/api/Admins'
    };

    title.textContent = `ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª ${role}`;

    async function load() {
      try {
        const res = await fetch(`${apiMap[role]}/${id}`);
        if (!res.ok) throw new Error(res.statusText);
        const obj = await res.json();
        buildForm(obj);
      } catch (e) {
        title.textContent = `Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„: ${e.message}`;
      }
    }

    function buildForm(obj) {
      const defs = {
        patient: [
          { name: 'paitentName', label: 'Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶', type: 'text' },
          { name: 'paitentNationalID', label: 'Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ', type: 'text' },
          { name: 'emergencyContact', label: 'Ø¬Ù‡Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø·Ø§Ø±Ø¦Ø©', type: 'text' },
          { name: 'recordID', label: 'Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø·Ø¨ÙŠ', type: 'number' },
          { name: 'userID', label: 'UserID', type: 'number' }
        ],
        hospital: [
          { name: 'hospitalName', label: 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰', type: 'text' },
          { name: 'location', label: 'Ø§Ù„Ù…ÙˆÙ‚Ø¹', type: 'text' },
          { name: 'phoneNumber', label: 'Ø§Ù„Ù‡Ø§ØªÙ', type: 'tel' },
          { name: 'bedCapacity', label: 'Ø³Ø¹Ø© Ø§Ù„Ø£Ø³Ø±Ø©', type: 'number' },
          { name: 'userID', label: 'UserID', type: 'number' }
        ],
        admin: [
          { name: 'userID', label: 'UserID', type: 'number' }
        ]
      };

      defs[role].forEach(field => {
        const wrapper = document.createElement('div');
        wrapper.classList.add('form-group');
        wrapper.innerHTML = `
          <label for="${field.name}">${field.label}</label>
          <input id="${field.name}" name="${field.name}" type="${field.type}" value="${obj[field.name] ?? ''}">
        `;
        form.insertBefore(wrapper, form.querySelector('.form-actions'));
      });
    }

    function showToast(message, type = "success") {
      const toast = document.createElement("div");
      toast.className = `toast align-items-center text-bg-${type} border-0 show mb-2`;
      toast.setAttribute("role", "alert");
      toast.setAttribute("aria-live", "assertive");
      toast.setAttribute("aria-atomic", "true");

      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      `;
      document.getElementById("toastContainer").appendChild(toast);
      setTimeout(() => toast.remove(), 5000);
    }

    form.addEventListener('submit', async e => {
      e.preventDefault();
      const body = {};
      new FormData(form).forEach((v, k) => {
        if (["recordID", "userID"].includes(k)) {
          body[k] = v.trim() === "" ? null : parseInt(v);
        } else {
          body[k] = v;
        }
      });

      try {
        const res = await fetch(`${apiMap[role]}/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        if (!res.ok) throw new Error(await res.text());

        showToast('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­', 'success');
        logAdminAction(`ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª ${role}`);
       
      } catch (e) {
        showToast('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸: ' + e.message, 'danger');
      }
    });

    async function logAdminAction(actionType) {
      const userID = localStorage.getItem("userID");
      if (!userID) return;

      try {
        const adminRes = await fetch(`https://localhost:7145/api/Admins`);
        const admins = await adminRes.json();
        const currentAdmin = admins.find(a => a.userID == userID);
        if (!currentAdmin) throw new Error("Admin not found");

        const log = {
          adminID: currentAdmin.adminID,
          actionType: actionType,
          timestamp: new Date().toISOString()
        };

        await fetch("https://localhost:7145/api/AdminActions", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(log)
        });
      } catch (err) {
        console.error("ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù†Ø´Ø§Ø·:", err);
      }
    }

    load();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
